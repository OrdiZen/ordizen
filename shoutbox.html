<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Shoutbox | OrdiZen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {margin:0;font-family:'Segoe UI',Arial,sans-serif;color:#fff;background:url('bg-1.jpg') no-repeat center center fixed;background-size:cover;min-height:100vh;}
    .navbar {background:#181b1e;border-bottom:2.5px solid #42f8ff;padding:0;position:sticky;top:0;z-index:10;display:flex;align-items:center;}
    .logo-oz {height:58px;width:58px;margin:2px 22px 2px 16px;animation:pulse 2.8s infinite alternate;filter:drop-shadow(0 0 12px #42f8ff88);transition:transform 0.2s;background:transparent;border-radius:50%;}
    .logo-oz:hover {transform:scale(1.07) rotate(-2deg);box-shadow:0 0 18px #42f8ffbb;filter:drop-shadow(0 0 32px #42f8ffcc);}
    @keyframes pulse {0%{filter:drop-shadow(0 0 8px #42f8ff44);}100%{filter:drop-shadow(0 0 32px #42f8ffcc);}}
    #menu-nav {display:flex;justify-content:center;align-items:center;gap:38px;flex:1;margin-left:10px;}
    #menu-nav a,#menu-nav span {color:#fff;text-decoration:none;font-weight:bold;font-size:1.08em;letter-spacing:0.02em;transition:color 0.18s;position:relative;}
    #menu-nav a:hover {color:#42f8ff;text-shadow:0 0 8px #42f8ff66;}
    .shoutbox-container {max-width:700px;margin:50px auto 0 auto;padding:30px 24px 22px 24px;background:rgba(28,30,34,0.88);border:2px solid #42f8ff;border-radius:14px;box-shadow:0 6px 44px #000a;min-height:420px;position:relative;}
    h1 {color:#42f8ff;text-align:center;text-shadow:0 0 12px #42f8ff;margin-bottom:22px;font-size:2em;letter-spacing:0.04em;}
    .message-list {height:270px;overflow-y:auto;padding:10px 2px 6px 2px;border-radius:10px;background:rgba(255,255,255,0.04);margin-bottom:22px;border:1.2px solid #42f8ff22;}
    .message {padding:8px 11px;margin:7px 0;background:#21262b;border-left:3px solid #42f8ff;border-radius:6px;word-break:break-all;font-size:1.08em;box-shadow:0 1px 10px #0004;}
    .message strong {color:#42f8ff;}
    .msg-info {text-align:center;color:#53fffa;margin-bottom:11px;font-size:1.01em;letter-spacing:0.01em;text-shadow:0 0 8px #42f8ff99;opacity:0.85;}
    form {display:flex;gap:10px;margin-top:7px;}
    input[type="text"] {flex:1;padding:11px;border-radius:8px;border:none;background:#fff;color:#222;font-size:1.04em;}
    button {padding:11px 26px;border:none;border-radius:8px;font-weight:bold;background:linear-gradient(90deg,#38fff7,#42a2ff);color:#181b1e;cursor:pointer;transition:background 0.15s;box-shadow:0 0 10px #42f8ff33;}
    button:hover {background:#42f8ff;box-shadow:0 0 18px #42f8ff88;color:#222;}
    .not-connected {color:#ffb9b9;text-align:center;margin:18px 0 0 0;font-size:1.08em;text-shadow:0 0 8px #9005, 0 0 8px #fff8;}
    @media (max-width:700px) {.shoutbox-container{max-width:98vw;margin:30px 2vw 0 2vw;}.message-list{height:34vw;min-height:150px;}}
  </style>
</head>
<body>
  <div class="navbar">
    <img src="logo-ordizen.png" alt="Logo OrdiZen" class="logo-oz" />
    <nav id="menu-nav">
      <a href="index.html">Accueil</a>
      <a href="shoutbox.html" style="color:#42f8ff;text-shadow:0 0 8px #42f8ff77;">Shoutbox</a>
      <a href="services.html">Services</a>
      <a href="contact.html">Contact</a>
    </nav>
  </div>
  <div class="shoutbox-container">
    <h1>Shoutbox</h1>
    <div class="msg-info">Discutez en direct avec la communauté OrdiZen.<br>Connexion requise pour écrire !</div>
    <div class="message-list" id="messages"></div>
    <form id="chat-form" autocomplete="off">
      <input type="text" id="message-input" placeholder="Votre message..." maxlength="240" required>
      <button type="submit">Envoyer</button>
    </form>
    <div class="not-connected" id="not-connected" style="display:none;">
      Vous devez être connecté pour envoyer un message.
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://ewsehfkbdsjzbpmxoesw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3c2VoZmtiZHNqemJwbXhvZXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NjIxMTYsImV4cCI6MjA2NTMzODExNn0.RMS2dRPUokGoyYiwxm1e0lrZa0VFWlgCXAMl5SU6N98';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function updateMenu() {
      const { data: { user } } = await supabase.auth.getUser();
      const nav = document.getElementById('menu-nav');
      while (nav.children.length > 4) nav.removeChild(nav.lastChild);

      if (!user) {
        let conn = document.createElement('a');
        conn.href = 'auth.html';
        conn.textContent = 'Connexion';
        nav.appendChild(conn);

        let insc = document.createElement('a');
        insc.href = 'auth.html#inscription';
        insc.textContent = 'Inscription';
        nav.appendChild(insc);
      } else {
        let deco = document.createElement('span');
        deco.className = "menu-link";
        deco.style.cursor = "pointer";
        deco.title = "Déconnexion";
        deco.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="29" height="22" fill="none" viewBox="0 2 20 22"><path d="M20 14.2h-14m11-4 4 4-4 4M4 18.2a4 4 0 1 1 0-8m0 8V8.2" stroke="#42f8ff" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" /></svg>`;
        deco.onclick = async () => { await supabase.auth.signOut(); updateMenu(); };
        nav.appendChild(deco);
      }
    }
    updateMenu();

    const messageList = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('message-input');
    const notConnected = document.getElementById('not-connected');
    let currentUser = null;
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      if (!user) {
        form.style.display = 'none';
        notConnected.style.display = '';
      } else {
        form.style.display = '';
        notConnected.style.display = 'none';
      }
    }
    checkAuth();

    async function loadMessages() {
      const { data, error } = await supabase.from('shoutbox').select('*').order('created_at', { ascending: false }).limit(30);
      if (!error) {
        messageList.innerHTML = '';
        data.reverse().forEach(msg => {
          const div = document.createElement('div');
          div.classList.add('message');
          div.innerHTML = `<strong>${msg.user} :</strong> ${msg.text}`;
          messageList.appendChild(div);
        });
        messageList.scrollTop = messageList.scrollHeight;
      }
    }
    loadMessages();

    supabase.channel('shoutbox-channel')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'shoutbox' }, loadMessages)
      .subscribe();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Veuillez vous connecter pour envoyer un message.");
        return;
      }
      const text = input.value.trim();
      if (!text) return;
      await supabase.from('shoutbox').insert([{ user: currentUser.email, text }]);
      input.value = '';
    });
  </script>
</body>
</html>
